<!-- note-card.component.html -->
<div class="note-card" [class.shared-note]="!isOwner()" [class.history-open]="isVersionHistoryVisible()">

  <!-- Header con titolo e versione -->
  <div class="note-header">
    <h3 class="note-title" (click)="onView()">{{ note.titolo }}</h3>

    <!-- Badge versione -->
    @if (shouldShowVersionIndicator()) {
      <div class="version-info">
        <span class="version-badge" [title]="'Versione ' + note.versionNumber">
          {{ getVersionBadgeText() }}
        </span>
        @if (hasMultipleVersions()) {
          <span class="multiple-versions-indicator" title="Questa nota ha versioni multiple">📚</span>
        }
      </div>
    }
  </div>

  <!-- Indicatore se è una nota condivisa (solo per utenti invitati) -->
  @if (!isOwner()) {
    <div class="shared-info">
      <span class="shared-badge">👥 Condivisa da {{ note.autore }}</span>
    </div>
  }

  <!-- Contenuto della nota -->
  <div class="note-content" (click)="onView()">
    <p class="note-text">{{ note.contenuto }}</p>
  </div>

  <!-- Tags -->
  @if (note.tags && note.tags.length > 0) {
    <div class="note-tags">
      @for (tag of note.tags; track tag) {
        <span class="tag">🏷️ {{ tag }}</span>
      }
    </div>
  }

  <!-- Cartelle -->
  @if (note.cartelle && note.cartelle.length > 0) {
    <div class="note-folders">
      @for (cartella of note.cartelle; track cartella) {
        <span class="folder">📁 {{ cartella }}</span>
      }
    </div>
  }

  <!-- Azioni della nota -->
  <div class="note-actions" (click)="$event.stopPropagation()">
    <div class="action-group primary-actions">
      <!-- Duplica -->
      <button class="action-btn duplicate-btn" (click)="onDuplicate()" title="Duplica nota">
        📋
      </button>

      <!-- Modifica (solo se ha permessi) -->
      @if (note.canEdit) {
        <button class="action-btn edit-btn" (click)="onEdit()" title="Modifica nota">
          ✏️
        </button>
      }

      <!--  pulsante per cronologia versioni -->
      @if (canViewHistory()) {
        <button
          class="action-btn history-btn"
          [class.has-multiple-versions]="hasMultipleVersions()"
          (click)="onShowVersionHistory()"
          [title]="hasMultipleVersions() ? 'Visualizza cronologia versioni (' + note.versionNumber + ' versioni)' : 'Visualizza cronologia versioni'">
          📚
        </button>
      }
    </div>

    <div class="action-group secondary-actions">
      <!-- Elimina (solo se proprietario) -->
      @if (note.canDelete && isOwner()) {
        <button class="action-btn delete-btn" (click)="onDelete()" title="Elimina nota">
          🗑️
        </button>
      }

      <!-- Rimuovi dalla condivisione (solo se utente invitato) -->
      @if (isSharedUser()) {
        <button class="action-btn remove-btn" (click)="onRemoveFromSharing()" title="Rimuoviti dalla condivisione">
          ❌
        </button>
      }
    </div>
  </div>

  <!-- Permessi e tipo -->
  <div class="note-permission">
    <span class="permission-badge" [title]="getPermissionText()">
      {{ getPermissionIcon() }} {{ getPermissionText() }}
    </span>
  </div>

  <!-- Footer con metadati -->
  <div class="note-footer">
    <div class="note-meta">
      <span class="author">👤 {{ note.autore }}</span>
      @if (isOwner()) {
        <span class="owner-badge">Tua</span>
      }
    </div>

    <div class="note-dates">
      @if (note.dataModifica !== note.dataCreazione) {
        <span class="modified-date" [title]="'Modificata: ' + formatDate(note.dataModifica)">
          ✏️ {{ getRelativeTime(note.dataModifica) }}
        </span>
      }
      <span class="created-date" [title]="'Creata: ' + formatDate(note.dataCreazione)">
        📅 {{ getRelativeTime(note.dataCreazione) }}
      </span>
    </div>
  </div>

  <!-- Indicatore di caratteri -->
  <div class="character-count">
    <div class="char-bar">
      <div
        class="char-fill"
        [style.width.%]="(note.contenuto.length / 280) * 100"
        [class.warning]="note.contenuto.length > 224"
        [class.danger]="note.contenuto.length > 252">
      </div>
    </div>
    <span class="char-text">{{ note.contenuto.length }}/280</span>
  </div>
</div>

<!-- Componente Cronologia Versioni -->
<app-note-version-history
  [noteId]="note.id"
  [isVisible]="isVersionHistoryVisible()"
  (close)="onCloseVersionHistory()"
  (restoreVersion)="onRestoreVersion($event)">
</app-note-version-history>




