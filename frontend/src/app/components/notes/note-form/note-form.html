<!-- note-form.html -->
@if (isVisible) {
  <div class="modal-overlay" (click)="onCancel()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        @if (isEditMode()) {
          <h2>‚úèÔ∏è Modifica Nota</h2>
        } @else {
          <h2>üìù Crea Nuova Nota</h2>
        }
        <button
          class="close-btn"
          (click)="onCancel()"
          type="button"
          [disabled]="isLoading">
          ‚úï
        </button>
      </div>

      <form [formGroup]="noteForm" (ngSubmit)="onSubmit()" class="note-form">
        <!-- Titolo -->
        <div class="form-group">
          <label for="titolo">üìù Titolo *</label>
          <input
            id="titolo"
            type="text"
            formControlName="titolo"
            class="form-input"
            [class.error]="noteForm.get('titolo')?.invalid && noteForm.get('titolo')?.touched"
            placeholder="Inserisci il titolo della nota"
            maxlength="100"
            [disabled]="isLoading">

          @if (noteForm.get('titolo')?.invalid && noteForm.get('titolo')?.touched) {
            <div class="field-error">
              @if (noteForm.get('titolo')?.errors?.['required']) {
                <span>Il titolo √® obbligatorio</span>
              }
              @if (noteForm.get('titolo')?.errors?.['maxlength']) {
                <span>Il titolo deve essere massimo 100 caratteri</span>
              }
            </div>
          }
        </div>

        <!-- Contenuto -->
        <div class="form-group">
          <label for="contenuto">üí¨ Contenuto *</label>
          <textarea
            id="contenuto"
            formControlName="contenuto"
            class="form-textarea"
            [class.error]="noteForm.get('contenuto')?.invalid && noteForm.get('contenuto')?.touched"
            placeholder="Scrivi qui il contenuto della tua nota (massimo 280 caratteri)"
            rows="4"
            maxlength="280"
            [disabled]="isLoading">
          </textarea>

          <!-- Character counter -->
          <div class="character-counter">
            <div class="character-progress">
              <div
                class="progress-bar"
                [style.width.%]="getCharacterWidth()"
                [class.warning]="characterCount() > 200"
                [class.danger]="characterCount() >= 280">
              </div>
            </div>
            <span class="character-count"
                  [class.warning]="characterCount() > 200"
                  [class.danger]="characterCount() >= 280">
              {{ getCharacterDisplay() }}
            </span>
          </div>

          @if (noteForm.get('contenuto')?.invalid && noteForm.get('contenuto')?.touched) {
            <div class="field-error">
              @if (noteForm.get('contenuto')?.errors?.['required']) {
                <span>Il contenuto √® obbligatorio</span>
              }
              @if (noteForm.get('contenuto')?.errors?.['maxlength']) {
                <span>Il contenuto deve essere massimo 280 caratteri</span>
              }
            </div>
          }
        </div>

        <!-- NUOVA SEZIONE: Gestione Permessi - Solo per creazione -->
        @if (!isEditMode()) {
          <div class="form-group">
            <label>üîí Impostazioni di condivisione</label>
            <div class="permission-options">
              <div class="permission-choice">
                <input
                  type="radio"
                  id="privata"
                  name="permission"
                  (change)="onPermissionTypeChange('PRIVATA')"
                  [checked]="permissionType() === 'PRIVATA'">
                <label for="privata">üîí Privata</label>
              </div>
              <div class="permission-choice">
                <input
                  type="radio"
                  id="pubblica"
                  name="permission"
                  (change)="onPermissionTypeChange('CONDIVISA_LETTURA')"
                  [checked]="permissionType() === 'CONDIVISA_LETTURA'">
                <label for="pubblica">üëÅÔ∏è Condivisa in lettura</label>
              </div>
            </div>

            <!-- Selezione utenti per condivisione -->
            @if (permissionType() !== 'PRIVATA') {
              <div class="users-selection">
                <label>üë• Seleziona utenti da condividere</label>
                <div class="users-dropdown" [class.open]="showUserDropdown()">
                  <button
                    type="button"
                    class="dropdown-toggle"
                    (click)="showUserDropdown.set(!showUserDropdown())">
                    Seleziona utenti ({{ selectedUsersForReading().length }} selezionati)
                  </button>

                  @if (showUserDropdown()) {
                    <div class="dropdown-menu">
                      @for (user of availableUsers(); track user.id) {
                        <div class="user-option">
                          <div class="user-select">
                            <input
                              type="checkbox"
                              [id]="'user-read-' + user.id"
                              [checked]="selectedUsersForReading().includes(user.username)"
                              (change)="onUserToggle(user.username, false)">
                            <label [for]="'user-read-' + user.id">{{ user.displayName }}</label>
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>

                @if (selectedUsersForReading().length > 0) {
                  <div class="selected-users">
                    <h4>Utenti selezionati:</h4>
                    <div class="user-tags">
                      @for (username of selectedUsersForReading(); track username) {
                        <span class="user-tag">
                          {{ username }}
                          <button type="button" (click)="onUserToggle(username, false)">‚úï</button>
                        </span>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }

        <!-- Tags -->
        <div class="form-group">
          <label for="tags">üè∑Ô∏è Tag</label>
          <div class="tag-input-container">
            <input
              type="text"
              [value]="tagInputValue()"
              (input)="onTagInputChange($event)"
              (keyup)="onTagInputKeyup($event)"
              class="form-input tag-input"
              placeholder="Aggiungi tag (premi Invio per aggiungere)"
              maxlength="50"
              autocomplete="off"
              [disabled]="isLoading">
            <button
              type="button"
              class="add-btn"
              (click)="addTag()"
              [disabled]="!canAddTag() || isLoading"
              aria-label="Aggiungi tag">
              +
            </button>
          </div>

          <!-- Tag suggestions -->
          @if (shouldShowTagSuggestions()) {
            <div class="suggestions">
              @for (tag of getFilteredTagSuggestions(); track tag) {
                <button
                  type="button"
                  class="suggestion-item"
                  (click)="addTagFromSuggestion(tag)"
                  tabindex="0"
                  [disabled]="isLoading">
                  üè∑Ô∏è {{ tag }}
                </button>
              }
            </div>
          }

          <!-- Selected tags -->
          @if (selectedTags().length > 0) {
            <div class="selected-tags">
              @for (tag of selectedTags(); track tag) {
                <span class="tag-chip">
                  üè∑Ô∏è {{ tag }}
                  <button
                    type="button"
                    class="remove-tag-btn"
                    (click)="removeTag(tag)"
                    [disabled]="isLoading"
                    [attr.aria-label]="'Rimuovi tag ' + tag">
                    ‚úï
                  </button>
                </span>
              }
            </div>
          }
        </div>

        <!-- Cartelle -->
        <div class="form-group">
          <label>üìÅ Cartelle (opzionali)</label>
          <div class="cartelle-dropdown" [class.open]="showCartelleDropdown()">
            <button
              type="button"
              class="dropdown-toggle"
              (click)="showCartelleDropdown.set(!showCartelleDropdown())"
              [disabled]="isLoading">
              Seleziona cartelle ({{ selectedCartelle().length }} selezionate)
            </button>

            @if (showCartelleDropdown()) {
              <div class="dropdown-menu">
                @if (availableCartelle().length > 0) {
                  @for (cartella of availableCartelle(); track cartella.id) {
                    <div class="cartella-option">
                      <input
                        type="checkbox"
                        [id]="'cartella-' + cartella.id"
                        [checked]="selectedCartelle().includes(cartella.nome)"
                        (change)="onCartellaToggle(cartella.nome)">
                      <label [for]="'cartella-' + cartella.id">{{ cartella.nome }}</label>
                    </div>
                  }
                } @else {
                  <div class="no-cartelle">Nessuna cartella disponibile</div>
                }
              </div>
            }
          </div>

          @if (selectedCartelle().length > 0) {
            <div class="selected-cartelle">
              @for (cartella of selectedCartelle(); track cartella) {
                <span class="cartella-tag">
                  üìÅ {{ cartella }}
                  <button type="button" (click)="onCartellaToggle(cartella)" [disabled]="isLoading">‚úï</button>
                </span>
              }
            </div>
          }
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button
            type="button"
            class="btn-cancel"
            (click)="onCancel()"
            [disabled]="isLoading">
            Annulla
          </button>
          <button
            type="submit"
            class="btn-save"
            [disabled]="noteForm.invalid || isLoading">
            @if (isLoading) {
              <span class="loading-spinner">‚è≥</span>
            }
            @if (isEditMode()) {
              Aggiorna Nota
            } @else {
              Crea Nota
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}
