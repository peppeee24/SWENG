<!-- note-form.html -->
@if (isVisible) {
  <div class="modal-overlay" (click)="onCancel()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        @if (isEditMode()) {
          <h2>‚úèÔ∏è Modifica Nota</h2>
        } @else {
          <h2>üìù Crea Nuova Nota</h2>
        }
        <button 
          class="close-btn" 
          (click)="onCancel()" 
          type="button"
          [disabled]="isLoading">
          ‚úï
        </button>
      </div>

      <form [formGroup]="noteForm" (ngSubmit)="onSubmit()" class="note-form">
        <!-- Titolo -->
        <div class="form-group">
          <label for="titolo">üìù Titolo *</label>
          <input
            id="titolo"
            type="text"
            formControlName="titolo"
            class="form-input"
            [class.error]="noteForm.get('titolo')?.invalid && noteForm.get('titolo')?.touched"
            placeholder="Inserisci il titolo della nota"
            maxlength="100"
            [disabled]="isLoading">
          
          @if (noteForm.get('titolo')?.invalid && noteForm.get('titolo')?.touched) {
            <div class="field-error">
              @if (noteForm.get('titolo')?.errors?.['required']) {
                <span>Il titolo √® obbligatorio</span>
              }
              @if (noteForm.get('titolo')?.errors?.['maxlength']) {
                <span>Il titolo deve essere massimo 100 caratteri</span>
              }
            </div>
          }
        </div>

        <!-- Contenuto -->
        <div class="form-group">
          <label for="contenuto">üí¨ Contenuto *</label>
          <textarea
            id="contenuto"
            formControlName="contenuto"
            class="form-textarea"
            [class.error]="noteForm.get('contenuto')?.invalid && noteForm.get('contenuto')?.touched"
            placeholder="Scrivi qui il contenuto della tua nota (massimo 280 caratteri)"
            rows="4"
            maxlength="280"
            [disabled]="isLoading">
          </textarea>
          
          <!-- Character counter -->
          <div class="character-counter">
            <div class="character-progress">
              <div 
                class="progress-bar" 
                [style.width.%]="getCharacterWidth()"
                [class.warning]="characterCount() > 200"
                [class.danger]="characterCount() >= 280">
              </div>
            </div>
            <span class="character-count" 
                  [class.warning]="characterCount() > 200"
                  [class.danger]="characterCount() >= 280">
              {{ getCharacterDisplay() }}
            </span>
          </div>
          
          @if (noteForm.get('contenuto')?.invalid && noteForm.get('contenuto')?.touched) {
            <div class="field-error">
              @if (noteForm.get('contenuto')?.errors?.['required']) {
                <span>Il contenuto √® obbligatorio</span>
              }
              @if (noteForm.get('contenuto')?.errors?.['maxlength']) {
                <span>Il contenuto deve essere massimo 280 caratteri</span>
              }
            </div>
          }
        </div>

        <!-- Tags -->
        <div class="form-group">
          <label for="tags">üè∑Ô∏è Tag</label>
          <div class="tag-input-container">
            <input
              type="text"
              [value]="getTagInputValue()"
              (input)="onTagInputChange($event)"
              (keydown)="onTagInputKeyDown($event)"
              class="form-input tag-input"
              placeholder="Aggiungi tag (premi Invio per aggiungere)"
              maxlength="50"
              autocomplete="off"
              [disabled]="isLoading">
            <button 
              type="button" 
              class="add-btn" 
              (click)="addTag()"
              [disabled]="!canAddTag() || isLoading"
              aria-label="Aggiungi tag">
              +
            </button>
          </div>

          <!-- Tag suggestions -->
          @if (shouldShowTagSuggestions()) {
            <div class="suggestions">
              @for (tag of getFilteredTagSuggestions(); track tag) {
                <button 
                  type="button" 
                  class="suggestion-item"
                  (click)="addTagFromSuggestion(tag)"
                  tabindex="0"
                  [disabled]="isLoading">
                  üè∑Ô∏è {{ tag }}
                </button>
              }
            </div>
          }

          <!-- Selected tags -->
          @if (hasSelectedTags()) {
            <div class="selected-items">
              @for (tag of getSelectedTags(); track tag) {
                <span class="selected-tag">
                  üè∑Ô∏è {{ tag }}
                  <button 
                    type="button" 
                    class="remove-btn" 
                    (click)="removeTag(tag)"
                    [attr.aria-label]="'Rimuovi tag: ' + tag"
                    [disabled]="isLoading">
                    √ó
                  </button>
                </span>
              }
            </div>
          }
        </div>

        <!-- Cartelle con Dropdown -->
        <div class="form-group">
          <label for="cartelle">üìÅ Cartelle (opzionale)</label>
          
          <!-- Dropdown per selezionare cartelle -->
          <div class="dropdown-container">
            <button 
              type="button" 
              class="dropdown-trigger"
              (click)="toggleCartelleDropdown()"
              [disabled]="isLoading || availableCartelle().length === 0"
              [class.disabled]="availableCartelle().length === 0">
              @if (availableCartelle().length === 0) {
                <span>üìÅ Nessuna cartella disponibile</span>
              } @else {
                <span>üìÅ Seleziona cartella</span>
              }
              <span class="dropdown-arrow" [class.open]="showCartelleDropdown()">‚ñº</span>
            </button>

            @if (showCartelleDropdown() && availableCartelle().length > 0) {
              <div class="dropdown-menu">
                @if (getUnselectedCartelle().length === 0) {
                  <div class="dropdown-item disabled">
                    <span>Tutte le cartelle sono gi√† selezionate</span>
                  </div>
                } @else {
                  @for (cartella of getUnselectedCartelle(); track cartella.id) {
                    <button
                      type="button"
                      class="dropdown-item"
                      (click)="selectCartella(cartella.id, cartella.nome)"
                      [disabled]="isLoading">
                      <span class="cartella-info">
                        <span class="cartella-nome">üìÅ {{ cartella.nome }}</span>
                        @if (cartella.descrizione) {
                          <span class="cartella-desc">{{ cartella.descrizione }}</span>
                        }
                        <span class="cartella-count">({{ cartella.numeroNote }} note)</span>
                      </span>
                    </button>
                  }
                }
              </div>
            }
          </div>

          <!-- Messaggio informativo se non ci sono cartelle -->
          @if (availableCartelle().length === 0) {
            <div class="info-message">
              <span>üí° Non hai ancora cartelle create.</span>
              <a href="/cartelle" target="_blank" class="create-cartella-link">
                Crea la tua prima cartella
              </a>
            </div>
          }

          <!-- Selected cartelle -->
          @if (hasSelectedCartelle()) {
            <div class="selected-items">
              @for (cartella of getSelectedCartelle(); track cartella) {
                <span class="selected-folder">
                  üìÅ {{ cartella }}
                  <button 
                    type="button" 
                    class="remove-btn" 
                    (click)="removeCartella(cartella)"
                    [attr.aria-label]="'Rimuovi cartella: ' + cartella"
                    [disabled]="isLoading">
                    √ó
                  </button>
                </span>
              }
            </div>
          }
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button 
            type="button" 
            class="btn-secondary" 
            (click)="onCancel()"
            [disabled]="isLoading">
            Annulla
          </button>
          
          <button 
            type="submit" 
            class="btn-primary" 
            [disabled]="noteForm.invalid || isLoading">
            @if (isLoading) {
              @if (isEditMode()) {
                <span class="loading">‚è≥ Aggiornamento...</span>
              } @else {
                <span class="loading">‚è≥ Salvataggio...</span>
              }
            } @else {
              @if (isEditMode()) {
                <span>‚úèÔ∏è Aggiorna Nota</span>
              } @else {
                <span>üìù Crea Nota</span>
              }
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}