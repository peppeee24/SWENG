@if (isVisible) {
  <div class="modal-overlay" (click)="onCancel()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <h2>
          @if (isEditMode()) {
            @if (isOwner()) {
              Modifica Nota (Proprietario)
            } @else {
              Modifica Nota (Condivisa)
            }
          } @else {
            Crea Nuova Nota
          }
        </h2>
        <button class="close-btn" (click)="onCancel()" type="button">‚úï</button>
      </div>

      <!-- Form -->
      <form [formGroup]="noteForm" (ngSubmit)="onSubmit()" class="note-form">
        <!-- Titolo -->
        <div class="form-group">
          <label for="titolo">üìù Titolo *</label>
          @if (isEditMode() && !isOwner()) {
            <p class="limited-edit-note">Come utente condiviso, puoi modificare il titolo della nota.</p>
          }
          <input
            id="titolo"
            type="text"
            formControlName="titolo"
            class="form-input"
            [class.error]="noteForm.get('titolo')?.invalid && noteForm.get('titolo')?.touched"
            placeholder="Inserisci il titolo della nota">

          @if (noteForm.get('titolo')?.invalid && noteForm.get('titolo')?.touched) {
            <div class="field-error">
              @if (noteForm.get('titolo')?.errors?.['required']) {
                <span>Il titolo √® obbligatorio</span>
              }
              @if (noteForm.get('titolo')?.errors?.['maxlength']) {
                <span>Il titolo deve essere massimo 100 caratteri</span>
              }
            </div>
          }
        </div>

        <!-- Contenuto -->
        <div class="form-group">
          <label for="contenuto">üí≠ Contenuto *</label>
          @if (isEditMode() && !isOwner()) {
            <p class="limited-edit-note">Come utente condiviso, puoi modificare il contenuto della nota.</p>
          }
          <textarea
            id="contenuto"
            formControlName="contenuto"
            class="form-textarea"
            [class.error]="noteForm.get('contenuto')?.invalid && noteForm.get('contenuto')?.touched"
            placeholder="Scrivi qui il contenuto della tua nota (massimo 280 caratteri)"
            rows="4">
          </textarea>

          <!-- Character counter -->
          <div class="character-counter">
            <div class="character-progress">
              <div
                class="progress-bar"
                [style.width.%]="(characterCount() / maxCharacters) * 100"
                [class.warning]="characterCount() > maxCharacters * 0.8"
                [class.danger]="characterCount() > maxCharacters">
              </div>
            </div>
            <span
              class="character-count"
              [class.warning]="characterCount() > maxCharacters * 0.8"
              [class.danger]="characterCount() > maxCharacters">
              {{ characterCount() }}/{{ maxCharacters }}
            </span>
          </div>

          @if (noteForm.get('contenuto')?.invalid && noteForm.get('contenuto')?.touched) {
            <div class="field-error">
              @if (noteForm.get('contenuto')?.errors?.['required']) {
                <span>Il contenuto √® obbligatorio</span>
              }
              @if (noteForm.get('contenuto')?.errors?.['maxlength']) {
                <span>Il contenuto deve essere massimo 280 caratteri</span>
              }
            </div>
          }
        </div>

        <!-- Gestione Permessi - Solo per creazione o proprietario in modifica -->
        @if (!isEditMode() || (isEditMode() && isOwner())) {
          <div class="form-group">
            <label>üîí Impostazioni di condivisione</label>

            @if (isEditMode() && isOwner()) {
              <div class="edit-permissions-note">
                <p><strong>Nota:</strong> Stai modificando i permessi di una nota esistente. Le modifiche ai permessi avranno effetto immediato.</p>
                <p> Non √® possibile ripristinare permessi precedenti dalla coronoligia del versionamento, ma solo titolo e descrizione</p>
              </div>
            }

            <div class="permission-options">
              <div class="permission-choice">
                <input
                  type="radio"
                  id="privata"
                  name="permission"
                  (change)="onPermissionTypeChange('PRIVATA')"
                  [checked]="permissionType() === 'PRIVATA'">
                <label for="privata">üîí Privata</label>
              </div>
              <div class="permission-choice">
                <input
                  type="radio"
                  id="pubblica"
                  name="permission"
                  (change)="onPermissionTypeChange('CONDIVISA_LETTURA')"
                  [checked]="permissionType() === 'CONDIVISA_LETTURA'">
                <label for="pubblica">üëÅÔ∏è Condivisa in lettura</label>
              </div>

              <div class="permission-choice">
                <input type="radio" id="scrittura" name="permission"
                       (change)="onPermissionTypeChange('CONDIVISA_SCRITTURA')"
                       [checked]="permissionType() === 'CONDIVISA_SCRITTURA'">
                <label for="scrittura">‚úèÔ∏è Condivisa in scrittura</label>
              </div>
            </div>

            <!-- Selezione utenti per condivisione -->
            @if (permissionType() !== 'PRIVATA') {
              <div class="users-selection">
                <label>üë• Seleziona utenti da condividere</label>
                <div class="users-dropdown" [class.open]="showUserDropdown()">
                  <button
                    type="button"
                    class="dropdown-toggle"
                    (click)="showUserDropdown.set(!showUserDropdown())">
                    @if (permissionType() === 'CONDIVISA_LETTURA') {
                      Seleziona utenti ({{ selectedUsersForReading().length }} selezionati)
                    } @else if (permissionType() === 'CONDIVISA_SCRITTURA') {
                      Seleziona utenti ({{ selectedUsersForWriting().length }} selezionati)
                    } @else {
                      Seleziona utenti (0 selezionati)
                    }
                  </button>

                  @if (showUserDropdown()) {
                    <div class="dropdown-menu">
                      @for (user of availableUsers(); track user.username) {
                        <div class="user-option" (click)="onUserToggle(user.username)">
                          <input
                            type="checkbox"
                            [checked]="isUserSelected(user.username)"
                            (click)="$event.stopPropagation()">
                          <span class="user-info">
                            <div class="user-primary">{{ user.username }}</div>
                            <div class="user-secondary">{{ user.displayName }}</div>
                          </span>
                        </div>
                      }
                      @if (availableUsers().length === 0) {
                        <div class="no-users">Nessun utente disponibile</div>
                      }
                    </div>
                  }
                </div>

                @if (permissionType() === 'CONDIVISA_LETTURA' && selectedUsersForReading().length > 0) {
                  <div class="selected-users">
                    <h4>Utenti con accesso in lettura:</h4>
                    <div class="user-tags">
                      @for (username of selectedUsersForReading(); track username) {
                        <span class="user-tag">
                          {{ username }}
                          <button type="button" (click)="onUserToggle(username)">√ó</button>
                        </span>
                      }
                    </div>
                  </div>
                }

                @if (permissionType() === 'CONDIVISA_SCRITTURA' && selectedUsersForWriting().length > 0) {
                  <div class="selected-users">
                    <h4>Utenti con accesso in scrittura:</h4>
                    <div class="user-tags">
                      @for (username of selectedUsersForWriting(); track username) {
                        <span class="user-tag">
                          {{ username }}
                          <button type="button" (click)="onUserToggle(username)">√ó</button>
                        </span>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        } @else {
          <!-- Messaggio informativo per utenti che stanno modificando note condivise -->
          <div class="form-group">
            <div class="shared-note-permissions-info">
              <div class="info-header">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <h3>Modifica nota condivisa</h3>
              </div>
              <div class="info-content">
                <p>Stai modificando una nota condivisa da <strong>{{ note?.autore }}</strong>.</p>
                <p>Come utente con permessi di scrittura puoi modificare:</p>
                <ul>
                  <li>‚úèÔ∏è Titolo e contenuto</li>
                  <li>üè∑Ô∏è Tag</li>
                  <li>üìÅ Cartelle</li>
                </ul>
                <p class="permission-limitation">
                  <strong>Nota:</strong> Solo il proprietario pu√≤ modificare i permessi di condivisione.
                </p>
              </div>
            </div>
          </div>
        }

        <!-- Tags - Sempre modificabili per ora -->
        <div class="form-group">
          <label>üè∑Ô∏è Tag</label>
          @if (isEditMode() && !isOwner()) {
            <p class="limited-edit-note">Come utente condiviso, puoi modificare i tag della nota.</p>
          }
          <div class="tag-input-container">
            <input
              type="text"
              class="form-input tag-input"
              placeholder="Aggiungi tag (premi Invio per aggiungere)"
              [value]="tagInputValue()"
              (input)="onTagInputChange($event)"
              (keyup)="onTagInputKeyup($event)">
            <button
              type="button"
              class="add-btn"
              [disabled]="!canAddTag()"
              (click)="addTag()">
              +
            </button>
          </div>

          <!-- Tag suggestions -->
          @if (shouldShowTagSuggestions()) {
            <div class="suggestions">
              @for (tag of getFilteredTagSuggestions(); track tag) {
                <button
                  type="button"
                  class="suggestion-item"
                  (click)="addTagFromSuggestion(tag)">
                  {{ tag }}
                </button>
              }
            </div>
          }

          <!-- Selected tags -->
          @if (selectedTags().length > 0) {
            <div class="selected-tags">
              @for (tag of selectedTags(); track tag) {
                <span class="tag-chip">
                  {{ tag }}
                  <button type="button" (click)="removeTag(tag)">√ó</button>
                </span>
              }
            </div>
          }
        </div>

        <!-- Cartelle -->
        <div class="form-group">
          <label>üìÅ Cartelle (opzionali)</label>
          @if (isEditMode() && !isOwner()) {
            <p class="limited-edit-note">Come utente condiviso, puoi modificare le cartelle della nota.</p>
          }
          <div class="cartelle-dropdown" [class.open]="showCartelleDropdown()">
            <button
              type="button"
              class="dropdown-toggle"
              (click)="showCartelleDropdown.set(!showCartelleDropdown())">
              Seleziona cartelle ({{ selectedCartelle().length }} selezionate)
            </button>

            @if (showCartelleDropdown()) {
              <div class="dropdown-menu">
                @for (cartella of availableCartelle(); track cartella.nome) {
                  <div class="cartella-option" (click)="onCartellaToggle(cartella.nome)">
                    <input
                      type="checkbox"
                      [checked]="selectedCartelle().includes(cartella.nome)"
                      (click)="$event.stopPropagation()">
                    <span>{{ cartella.nome }}</span>
                  </div>
                }
                @if (availableCartelle().length === 0) {
                  <div class="no-cartelle">Nessuna cartella disponibile</div>
                }
              </div>
            }
          </div>

          <!-- Selected cartelle -->
          @if (selectedCartelle().length > 0) {
            <div class="selected-cartelle">
              @for (cartella of selectedCartelle(); track cartella) {
                <span class="cartella-tag">
                  üìÅ {{ cartella }}
                  <button type="button" (click)="onCartellaToggle(cartella)">√ó</button>
                </span>
              }
            </div>
          }
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="onCancel()">
            Annulla
          </button>
          <button
            type="submit"
            class="btn-save"
            [disabled]="noteForm.invalid || isLoading"
            [class.loading]="isLoading">
            @if (isLoading) {
              <span>‚è≥ Salvando...</span>
            } @else if (isEditMode()) {
              @if (isOwner()) {
                <span>üíæ Aggiorna Nota</span>
              } @else {
                <span>üíæ Salva Modifiche</span>
              }
            } @else {
              <span>‚ú® Crea Nota</span>
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}
