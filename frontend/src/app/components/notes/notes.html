<div class="notes-container">
  <!-- Header -->
  <header class="notes-header">
    <div class="header-content">
      <div class="logo">
        <h1>ğŸ“ NOTA BENE</h1>
        @if (currentUser()) {
          <p class="welcome-text">Ciao, {{ displayName() }}!</p>
        }
      </div>
      <nav class="nav-actions">
        <button class="cartelle-btn" (click)="router.navigate(['/cartelle'])">
          ğŸ“ Cartelle
        </button>
        <button class="stats-btn" (click)="toggleStats()">
          ğŸ“Š {{ showStats() ? 'Nascondi' : 'Mostra' }} Statistiche
        </button>
        <button class="logout-btn" (click)="onLogout()">
          ğŸšª Logout
        </button>
      </nav>
    </div>
  </header>

  <!-- Stats Panel -->
  @if (showStats() && userStats()) {
    <section class="stats-panel">
      <div class="stats-content">
        <h3>ğŸ“Š Le tue statistiche</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-value">{{ userStats()!.noteCreate }}</span>
            <span class="stat-label">Note create</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ userStats()!.noteCondivise }}</span>
            <span class="stat-label">Note condivise</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ userStats()!.tagUtilizzati }}</span>
            <span class="stat-label">Tag utilizzati</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ userStats()!.cartelleCreate }}</span>
            <span class="stat-label">Cartelle create</span>
          </div>
        </div>
      </div>
    </section>
  }

  <!-- Main Content -->
  <main class="main-content">
    <!-- Controls Bar -->
    <div class="controls-bar">
      <!-- Create Button -->
      <button class="create-btn" (click)="showCreateForm()">
        â• Crea Nota
      </button>

      <!-- Filter Buttons -->
      <div class="filter-buttons">
        <button
          [class]="getFilterButtonClass('all')"
          (click)="onFilterChange('all')">
          ğŸ“‹ Tutte
        </button>
        <button
          [class]="getFilterButtonClass('own')"
          (click)="onFilterChange('own')">
          ğŸ“ Mie Note
        </button>
        <button
          [class]="getFilterButtonClass('shared')"
          (click)="onFilterChange('shared')">
          ğŸ‘¥ Condivise
        </button>
      </div>

      <!-- Search Form -->
      <form [formGroup]="searchForm" (ngSubmit)="onSearch()" class="search-form">
        <input
          type="text"
          formControlName="query"
          placeholder="ğŸ” Cerca note, tag, cartelle..."
          class="search-input">
        <button type="submit" class="search-btn">Cerca</button>
      </form>
    </div>

    @if (userStats()) {
      <div class="quick-filters">
        <!-- Tags -->
        @if (userStats()!.allTags.length > 0) {
          <div class="filter-section">
            <h4>ğŸ·ï¸ Tags</h4>
            <div class="filter-chips">
              @for (tag of userStats()!.allTags; track tag) {
                <button
                  class="filter-chip"
                  [class.active]="selectedTag() === tag"
                  (click)="onTagFilter(tag)">
                  {{ tag }}
                </button>
              }
            </div>
          </div>
        }

        <!-- Cartelle -->
        @if (userStats()!.allCartelle.length > 0) {
          <div class="filter-section">
            <h4>ğŸ“ Cartelle</h4>
            <div class="filter-chips">
              @for (cartella of userStats()!.allCartelle; track cartella) {
                <button
                  class="filter-chip"
                  [class.active]="selectedCartella() === cartella"
                  (click)="onCartellaFilter(cartella)">
                  {{ cartella }}
                </button>
              }
            </div>
          </div>
        }

        <!-- Filtro Autore -->
        @if (availableAutori().length > 0) {
          <div class="filter-section">
            <h4>ğŸ‘¤ Autore</h4>
            <div class="author-filter-container">
              <select
                class="form-select"
                [value]="selectedAutore()"
                (change)="onAutoreFilter($any($event.target).value)">
                <option value="">Tutti gli autori</option>
                @for (autore of availableAutori(); track autore) {
                  <option [value]="autore">{{ autore }}</option>
                }
              </select>
              @if (selectedAutore()) {
                <button
                  class="clear-filter-btn"
                  (click)="clearAutoreFilter()"
                  title="Rimuovi filtro autore">
                  âœ•
                </button>
              }
            </div>
          </div>


        }



        <!-- Filtri Data -->
        <div class="filter-section">
          <h4>ğŸ“… Filtro Date</h4>
          <div class="date-filter-container">
            <div class="date-input-group">
              <label for="data-inizio">Creata dal:</label>
              <input
                id="data-inizio"
                type="date"
                class="form-input date-input"
                [value]="selectedDataInizio()"
                (change)="onDataFilter('inizio', $any($event.target).value)"
                placeholder="Data inizio">
            </div>
            <div class="date-input-group">
              <label for="data-fine">Creata fino al:</label>
              <input
                id="data-fine"
                type="date"
                class="form-input date-input"
                [value]="selectedDataFine()"
                (change)="onDataFilter('fine', $any($event.target).value)"
                placeholder="Data fine">
            </div>
            @if (selectedDataInizio() || selectedDataFine()) {
              <button
                class="clear-filter-btn date-clear"
                (click)="clearDateFilters()"
                title="Rimuovi filtri data">
                âœ• Date
              </button>
            }
          </div>
        </div>



        <!-- Clear Filters -->
        @if (hasActiveFilters()) {
          <button class="clear-filters-btn" (click)="clearFilters()">
            âœ• Pulisci filtri
          </button>
        }
      </div>
    }

    <!-- Active Filter Info -->
    @if (selectedTag() || selectedCartella() || searchQuery() || selectedAutore() || selectedDataInizio() || selectedDataFine()) {
      <div class="active-filter-info">

        <!-- Filtro Cartella -->
        @if (selectedCartella()) {
          <div class="filter-info cartella-filter">
            <span class="filter-icon">ğŸ“</span>
            <span class="filter-text">
          Visualizzando note della cartella: <strong>{{ selectedCartella() }}</strong>
        </span>
            <button class="filter-remove-btn" (click)="clearFilters()" title="Rimuovi filtro">âœ•</button>
          </div>
        }

        <!-- Filtro Tag -->
        @if (selectedTag()) {
          <div class="filter-info tag-filter">
            <span class="filter-icon">ğŸ·ï¸</span>
            <span class="filter-text">
          Filtro per tag: <strong>{{ selectedTag() }}</strong>
        </span>
            <button class="filter-remove-btn" (click)="clearFilters()" title="Rimuovi filtro">âœ•</button>
          </div>
        }

        <!-- Filtro Ricerca -->
        @if (searchQuery()) {
          <div class="filter-info search-filter">
            <span class="filter-icon">ğŸ”</span>
            <span class="filter-text">
          Ricerca: <strong>{{ searchQuery() }}</strong>
        </span>
            <button class="filter-remove-btn" (click)="clearFilters()" title="Rimuovi filtro">âœ•</button>
          </div>
        }

        <!-- Filtro Autore -->
        @if (selectedAutore()) {
          <div class="filter-info author-filter">
            <span class="filter-icon">ğŸ‘¤</span>
            <span class="filter-text">
          Autore: <strong>{{ selectedAutore() }}</strong>
        </span>
            <button class="filter-remove-btn" (click)="clearAutoreFilter()" title="Rimuovi filtro">âœ•</button>
          </div>
        }

        <!-- Filtro Date -->
        @if (selectedDataInizio() || selectedDataFine()) {
          <div class="filter-info date-filter">
            <span class="filter-icon">ğŸ“…</span>
            <span class="filter-text">
          @if (selectedDataInizio() && selectedDataFine()) {
            Periodo: <strong>{{ selectedDataInizio() }} - {{ selectedDataFine() }}</strong>
          } @else if (selectedDataInizio()) {
            Dal: <strong>{{ selectedDataInizio() }}</strong>
          } @else {
            Fino al: <strong>{{ selectedDataFine() }}</strong>
          }
        </span>
            <button class="filter-remove-btn" (click)="clearDateFilters()" title="Rimuovi filtro">âœ•</button>
          </div>
        }

        <!-- Pulsante per tornare alle cartelle se filtro attivo -->
        @if (selectedCartella()) {
          <div class="navigation-helper">
            <button class="back-to-cartelle-btn" (click)="router.navigate(['/cartelle'])">
              â† Torna alle Cartelle
            </button>
          </div>
        }
      </div>
    }
    <!-- Error Message -->
    @if (error()) {
      <div class="error-message">
        âŒ {{ error() }}
        <button class="retry-btn" (click)="loadNotes()">Riprova</button>
      </div>
    }

    <!-- Loading State -->
    @if (isLoading()) {
      <div class="loading-state">
        <div class="loading-spinner">â³</div>
        <p>Caricamento note...</p>
      </div>
    }

    <!-- Notes Grid -->
    @if (!isLoading() && !error()) {
      @if (filteredNotes().length > 0) {


        <div class="notes-grid">
          @for (note of filteredNotes(); track note.id) {
            <app-note-card
              [note]="note"
              [currentUsername]="currentUsername()"
              (edit)="showEditForm($event)"
              (delete)="onNoteDelete($event)"
              (duplicate)="onNoteDuplicate($event)"
              (view)="onNoteView($event)"
              (removeFromSharing)="onRemoveFromSharing($event)"
              (restoreVersion)="onRestoreVersion($event)">
            </app-note-card>
          }
        </div>

        <!-- Notes Count -->
        <div class="notes-count">
          Mostrate {{ filteredNotes().length }} di {{ notes().length }} note
        </div>
      } @else {
        <!-- Empty State -->
        <div class="empty-state">
          @if (notes().length === 0) {
            <div class="empty-icon">ğŸ“</div>
            <h3>Nessuna nota ancora</h3>
            <p>Inizia creando la tua prima nota per organizzare i tuoi pensieri!</p>
            <button class="create-first-btn" (click)="showCreateForm()">
              âœ¨ Crea la prima nota
            </button>
          } @else {
            <div class="empty-icon">ğŸ”</div>
            <h3>Nessun risultato</h3>
            <p>Non abbiamo trovato note che corrispondono ai tuoi criteri di ricerca.</p>
            <button class="clear-search-btn" (click)="clearFilters()">
              ğŸ”„ Pulisci filtri
            </button>
          }
        </div>
      }
    }
  </main>

  <!-- Note Form Modal -->
  <app-note-form
    [note]="selectedNote()"
    [isVisible]="showNoteForm()"
    [allTags]="allTags()"
    [allCartelle]="allCartelle()"
    [isLoading]="isLoading()"
    (save)="onNoteSave($event)"
    (cancel)="hideNoteForm()">
  </app-note-form>
</div>
<!-- notes.component.html - Aggiungi queste sezioni per il feedback del versionamento -->

<!-- Messaggi di feedback per il versionamento (da aggiungere dopo l'header esistente) -->
<div class="feedback-container">

  <!-- Messaggio di successo ripristino versione -->
  @if (versionRestoreSuccess()) {
    <div class="feedback-message success-message">
      <div class="message-content">
        <span class="message-icon">âœ…</span>
        <span class="message-text">{{ versionRestoreSuccess() }}</span>
        <button class="close-message-btn" (click)="closeVersionFeedback()">âœ•</button>
      </div>
    </div>
  }

  <!-- Messaggio di errore ripristino versione -->
  @if (versionRestoreError()) {
    <div class="feedback-message error-message">
      <div class="message-content">
        <span class="message-icon">âš ï¸</span>
        <span class="message-text">{{ versionRestoreError() }}</span>
        <button class="close-message-btn" (click)="closeVersionFeedback()">âœ•</button>
      </div>
    </div>
  }

  <!-- Loading ripristino versione -->
  @if (versionRestoreLoading()) {
    <div class="feedback-message loading-message">
      <div class="message-content">
        <div class="loading-spinner-small"></div>
        <span class="message-text">Ripristino versione in corso...</span>
      </div>
    </div>
  }
</div>



<!-- Stili CSS da aggiungere al file notes.component.css -->
<style>
  .feedback-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1500;
    max-width: 400px;
  }

  .feedback-message {
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    margin-bottom: 12px;
    border-left: 4px solid;
    animation: slideInRight 0.3s ease-out;
  }

  .feedback-message.success-message {
    border-left-color: #10b981;
    background: linear-gradient(135deg, #f0fff4 0%, #f0fff4 100%);
  }

  .feedback-message.error-message {
    border-left-color: #ef4444;
    background: linear-gradient(135deg, #fef2f2 0%, #fef2f2 100%);
  }

  .feedback-message.loading-message {
    border-left-color: #667eea;
    background: linear-gradient(135deg, #f0f4ff 0%, #f0f4ff 100%);
  }

  .message-content {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    gap: 12px;
  }

  .message-icon {
    font-size: 20px;
    flex-shrink: 0;
  }

  .message-text {
    flex: 1;
    font-weight: 500;
    color: #374151;
    line-height: 1.5;
  }

  .close-message-btn {
    background: none;
    border: none;
    font-size: 16px;
    color: #9ca3af;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .close-message-btn:hover {
    color: #6b7280;
    background: rgba(0, 0, 0, 0.05);
  }

  .loading-spinner-small {
    width: 20px;
    height: 20px;
    border: 2px solid #e5e7eb;
    border-top: 2px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    flex-shrink: 0;
  }

  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Responsive design per i messaggi */
  @media (max-width: 768px) {
    .feedback-container {
      top: 10px;
      right: 10px;
      left: 10px;
      max-width: none;
    }

    .message-content {
      padding: 12px 16px;
    }

    .message-text {
      font-size: 0.9rem;
    }
  }
</style>
